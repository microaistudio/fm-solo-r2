<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowMatic Terminal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Login Screen */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: #f5f5f5;
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 4px;
            font-weight: 600;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .login-btn {
            background: #86b97f;
            color: white;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .login-btn:hover {
            background: #7ab373;
        }
        
        .skip-login-btn {
            background: white;
            color: #666;
            padding: 12px 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 12px;
            width: 100%;
        }
        
        .skip-login-btn:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }
        
        /* Main Terminal */
        .terminal-container {
            display: none;
            height: 100vh;
            background: #f5f5f5;
        }
        
        /* Header */
        .header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: bold;
            color: #86b97f;
        }
        
        .counter-info {
            padding: 8px 16px;
            background: #f0f0f0;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .demo-indicator {
            color: #ff9800;
            font-weight: 600;
            padding: 5px 10px;
            background: #fff3cd;
            border-radius: 20px;
            font-size: 13px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .agent-info {
            text-align: right;
        }
        
        .agent-name {
            font-weight: 600;
            color: #333;
        }
        
        .session-time {
            font-size: 14px;
            color: #666;
        }
        
        .logout-btn {
            padding: 8px 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            height: calc(100vh - 74px);
            gap: 20px;
            padding: 20px;
        }
        
        /* Queue Panel */
        .queue-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .queue-header {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #e8e8e8;
        }
        
        .queue-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }
        
        .queue-stats {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }
        
        .queue-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        /* Queue items */
        .queue-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .queue-item:hover {
            background: #e8f5e9;
            transform: translateX(5px);
        }
        
        .queue-item.priority {
            border-left: 4px solid #ff9800;
        }
        
        /* Park list styling */
        .park-list {
            padding: 10px;
        }
        
        .park-item {
            padding: 15px;
            background: #fff3cd;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #ffc107;
        }
        
        .park-item:hover {
            background: #ffeaa7;
            transform: translateX(5px);
        }
        
        .queue-ticket {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .ticket-number {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .ticket-time {
            font-size: 13px;
            color: #666;
        }
        
        .ticket-priority {
            font-size: 12px;
            padding: 3px 8px;
            background: #f0f0f0;
            border-radius: 12px;
            color: #666;
        }
        
        .queue-item.priority .ticket-priority {
            background: #ff9800;
            color: white;
        }
        
        .ticket-action {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #666;
            font-size: 14px;
        }
        
        /* Center Panel */
        .center-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        /* Current Ticket */
        .current-ticket {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .ticket-service-info {
            position: absolute;
            top: 20px;
            right: 20px;
            text-align: right;
        }
        
        .service-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        .service-subtitle {
            font-size: 13px;
            color: #666;
        }
        
        .serving-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }
        
        .ticket-display {
            font-size: 72px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            line-height: 1;
        }
        
        .ticket-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 30px;
        }
        
        .info-item {
            text-align: center;
        }
        
        .info-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }
        
        .customer-info {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .customer-detail {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .empty-state {
            padding: 40px;
            text-align: center;
            color: #999;
            font-size: 18px;
        }
        
        /* Action buttons grid - corrected layout */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(3, 80px);
            gap: 12px;
        }
        
        .action-btn {
            background: white;
            border: 2px solid;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
        }
        
        .action-btn i {
            font-size: 20px;
        }
        
        /* Large NEXT button on the left */
        .btn-next {
            grid-column: 1 / 3;
            grid-row: 1 / 3;
            background: #86b97f;
            color: white;
            font-size: 18px;
            border: none;
        }
        
        .btn-next i {
            font-size: 36px;
        }
        
        /* Outline style buttons */
        .btn-recall {
            border-color: #ff9800;
            color: #ff9800;
        }
        
        .btn-end {
            background: #28a745;
            color: white;
            border: none;
        }
        
        .btn-no-show {
            border-color: #dc3545;
            color: #dc3545;
        }
        
        .btn-park {
            border-color: #007bff;
            color: #007bff;
        }
        
        .btn-transfer {
            border-color: #17a2b8;
            color: #17a2b8;
        }
        
        .btn-transfer-ctr {
            border-color: #e91e63;
            color: #e91e63;
        }
        
        .btn-open-close {
            border-color: #ffc107;
            color: #ffc107;
        }
        
        .btn-recycle {
            border-color: #20c997;
            color: #20c997;
        }
        
        .btn-supervisor {
            border-color: #6f42c1;
            color: #6f42c1;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        /* Right Panel */
        .right-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab-btn.active {
            color: #333;
            border-bottom-color: #86b97f;
            background: white;
        }
        
        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        /* Activity Feed */
        .activity-feed {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .activity-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        
        .activity-time {
            color: #666;
            font-size: 12px;
        }
        
        /* Stats */
        .stats-grid {
            display: grid;
            gap: 15px;
        }
        
        .stat-card {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        
        /* Progress bar styling */
        .progress-bar {
            height: 4px;
            background: linear-gradient(to right, #86b97f 0%, #86b97f 30%, #ffc107 30%, #ffc107 60%, #dc3545 60%, #dc3545 100%);
            margin-bottom: 20px;
        }
        
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 10px 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #666;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
        }
        
        .status-indicator.disconnected {
            background: #dc3545;
        }
        
        /* Transfer Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 500px;
        }
        
        .modal-header {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .service-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .service-option {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .service-option:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }
        
        .service-option.selected {
            border-color: #667eea;
            background: #e8f0fe;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .modal-btn.primary {
            background: #667eea;
            color: white;
        }
        
        .modal-btn.secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .footer button {
            padding: 6px 16px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .footer button:hover {
            background: #f5f5f5;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-out;
            z-index: 2000;
        }
        
        .notification.success {
            background: #28a745;
        }
        
        .notification.error {
            background: #dc3545;
        }
        
        .notification.warning {
            background: #ffc107;
            color: #333;
        }
        
        .notification.info {
            background: #17a2b8;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <div class="login-header">
                <div style="width: 80px; height: 80px; background: #86b97f; border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 36px; color: white;">
                    🎯
                </div>
                <h1>FlowMatic Terminal</h1>
                <p style="color: #666; margin-top: 8px;">Sign in to continue</p>
            </div>
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="username" style="font-size: 14px; color: #666; margin-bottom: 6px; display: block;">Username</label>
                    <input type="text" id="username" required placeholder="Enter your username" value="demo" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                </div>
                
                <div class="form-group">
                    <label for="password" style="font-size: 14px; color: #666; margin-bottom: 6px; display: block;">Password</label>
                    <input type="password" id="password" required placeholder="Enter your password" value="demo123" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                </div>
                <div class="form-group">
                    <label for="counter" style="font-size: 14px; color: #666; margin-bottom: 6px; display: block;">Select Counter</label>
                    <select id="counter" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white;">
                        <option value="">Choose a counter...</option>
                    </select>
                </div>
                <button type="submit" class="login-btn">Sign In</button>
                <button type="button" class="skip-login-btn" onclick="skipLogin()">
                    Skip Login (Demo Mode)
                </button>
                <p style="font-size: 13px; color: #999; text-align: center; margin-top: 8px;">
                    Use demo account for testing (or press Ctrl+D)
                </p>
            </form>
        </div>
    </div>
    
    <!-- Main Terminal -->
    <div class="terminal-container" id="terminalScreen">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="logo">🎯 FlowMatic Pro</div>
                <div class="counter-info" id="counterInfo">Counter 1</div>
                <div class="demo-indicator" id="demoIndicator" style="display: none;">Demo Mode</div>
            </div>
            <div class="header-right" style="display: flex; align-items: center; gap: 20px;">
                <div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <span>🔔</span>
                        <span style="font-size: 14px;">Alerts (0)</span>
                    </div>
                </div>
                <div>
                    <button style="padding: 6px 12px; background: white; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 14px;">⚙️ Settings</button>
                </div>
                <div class="agent-info">
                    <div class="agent-name" id="agentName">Demo Agent</div>
                    <div class="session-time" id="sessionTime" style="font-size: 13px; color: #666;">agent • Level 5</div>
                </div>
                <button class="logout-btn" onclick="handleLogout()">🚪 Logout</button>
            </div>
        </header>
        
        <!-- Progress bar -->
        <div class="progress-bar"></div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Queue Panel -->
            <div class="queue-panel">
                <div class="queue-header">
                    <h2 class="queue-title">Queue Management</h2>
                    <select id="serviceSelect" onchange="loadQueue()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px;">
                        <option value="">Select Service</option>
                    </select>
                    <div class="queue-stats">
                        <span>Waiting: <strong id="waiting-count">0</strong></span>
                        <span style="margin-left: 15px;">Serving: <strong id="serving-count">0</strong></span>
                    </div>
                </div>
                <div class="queue-list" id="queue-list">
                    <div class="empty-state">Select a service to view queue</div>
                </div>
            </div>
            
            <!-- Center Panel -->
            <div class="center-panel">
                <!-- Current Ticket -->
                <div class="current-ticket">
                    <div id="current-ticket-display">
                        <div class="empty-state">No ticket being served</div>
                    </div>
                </div>
                
                <!-- Action buttons -->
                <div class="action-buttons">
                    <!-- NEXT button - large on left -->
                    <button class="action-btn btn-next" onclick="handleCallNext()">
                        <i>▶</i>
                        <span>NEXT</span>
                    </button>
                    
                    <!-- Top row right side -->
                    <button class="action-btn btn-recall" onclick="handleRecall()">
                        <i>↻</i>
                        <span>RECALL</span>
                    </button>
                    
                    <button class="action-btn btn-end" onclick="handleComplete()">
                        <i>✓</i>
                        <span>END</span>
                    </button>
                    
                    <!-- Bottom row -->
                    <button class="action-btn btn-no-show" onclick="handleNoShow()">
                        <i>✕</i>
                        <span>NO SHOW</span>
                    </button>
                    
                    <button class="action-btn btn-recycle" onclick="handleRecycle()" style="display: none;">
                        <i>♻</i>
                        <span>RECYCLE</span>
                    </button>
                    
                    <button class="action-btn btn-park" onclick="handlePark()" style="display: none;">
                        <i>P</i>
                        <span>PARK</span>
                    </button>
                    
                    <button class="action-btn btn-transfer" onclick="handleTransfer()">
                        <i>⬌</i>
                        <span>TRANSFER</span>
                    </button>
                    
                    <button class="action-btn btn-transfer-ctr" onclick="handleTransferCounter()">
                        <i>🏪</i>
                        <span>TRANSFER CTR</span>
                    </button>
                    
                    <button class="action-btn btn-supervisor" onclick="callSupervisor()">
                        <i>👤</i>
                        <span>SUPERVISOR</span>
                    </button>
                </div>
            </div>
            
            <!-- Right Panel -->
            <div class="right-panel">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('activity')">
                        <i>📊</i> Activity
                    </button>
                    <button class="tab-btn" onclick="switchTab('stats')">
                        <i>📈</i> Stats
                    </button>
                    <button class="tab-btn" onclick="switchTab('park')">
                        <i>🅿️</i> Park
                    </button>
                    <button class="tab-btn" onclick="switchTab('messages')">
                        <i>💬</i> Messages
                    </button>
                </div>
                <div class="tab-content">
                    <div id="activity-tab" class="tab-pane active">
                        <div class="activity-feed" id="activity-feed">
                            <div class="activity-item">
                                <span class="activity-time">Just now</span>
                                <span class="activity-text">System started</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="stats-tab" class="tab-pane">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">Served Today</div>
                                <div class="stat-value" id="served-today">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Avg Service Time</div>
                                <div class="stat-value" id="avg-service-time">0:00</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">My Rating</div>
                                <div class="stat-value">⭐ 4.8</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="park-tab" class="tab-pane">
                        <div class="park-list" id="park-list">
                            <div class="empty-state">No parked tickets</div>
                        </div>
                    </div>
                    
                    <div id="messages-tab" class="tab-pane">
                        <div class="messages-list">
                            <div class="empty-state">No messages</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="footer">
            <div class="connection-status">
                <span class="status-indicator" id="connectionStatus"></span>
                <span id="connectionText">Connected • Real-time sync active</span>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="alert('Break time')">Break</button>
                <button onclick="openHelp()">Help</button>
                <button onclick="callSupervisor()">Supervisor</button>
            </div>
            <div>
                Session Time: <span id="sessionTimer">00:00:00</span>
            </div>
        </footer>
    </div>
    
    <!-- Transfer Modal -->
    <div id="transferModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-header">Transfer Ticket to Service</h2>
            <div class="service-grid" id="transferServices">
                <!-- Services will be populated here -->
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeTransferModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmTransfer()">Transfer</button>
            </div>
        </div>
    </div>
    
    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Configuration
        const API_BASE = window.location.origin;
        
        // State management
        let session = null;
        let socket = null;
        let currentTicket = null;
        let queueData = [];
        let parkedTickets = [];
        let services = [];
        let isDemoMode = false;
        let selectedTransferService = null;
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎯 FlowMatic Terminal Starting...');
            testConnections(); // Test API connections
            checkSavedSession();
            loadCounters();
            
            // Add keyboard shortcut for demo mode (Ctrl+D)
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'd' && document.getElementById('loginScreen').style.display !== 'none') {
                    e.preventDefault();
                    skipLogin();
                }
            });
        });
        
        // Enhanced connection testing
        function testConnections() {
            console.log('🔍 Testing API connections...');
            
            // Test basic endpoints
            const testEndpoints = [
                '/api/health',
                '/api/kiosk/services',
                '/api/admin/settings',
                '/api/terminal/session'
            ];
            
            testEndpoints.forEach(async (endpoint) => {
                try {
                    const response = await fetch(API_BASE + endpoint);
                    console.log(`${endpoint}: ${response.status} ${response.statusText}`);
                } catch (error) {
                    console.log(`${endpoint}: Connection failed -`, error.message);
                }
            });
        }
        
        // Load counters for login
        async function loadCounters() {
            const counterSelect = document.getElementById('counter');
            
            // Default counters to show immediately
            const defaultCounters = [
                { id: 1, name: 'Counter 1', number: 1 },
                { id: 2, name: 'Counter 2', number: 2 },
                { id: 3, name: 'VIP Counter', number: 3 },
                { id: 4, name: 'Technical Counter', number: 4 }
            ];
            
            // Populate with default counters first
            counterSelect.innerHTML = '<option value="">Choose a counter...</option>';
            defaultCounters.forEach(counter => {
                counterSelect.innerHTML += `<option value="${counter.id}">${counter.name}</option>`;
            });
            
            // Try to load from API (don't worry if it fails)
            try {
                // Try multiple possible endpoints
                const endpoints = [
                    '/api/admin/counters',
                    '/api/monitor/counters', 
                    '/api/counters',
                    '/api/terminal/counters'
                ];
                
                for (const endpoint of endpoints) {
                    try {
                        const response = await fetch(API_BASE + endpoint);
                        if (response.ok) {
                            const data = await response.json();
                            const counters = data.counters || data || [];
                            
                            if (counters.length > 0) {
                                // Replace with API data if available
                                counterSelect.innerHTML = '<option value="">Choose a counter...</option>';
                                counters.forEach(counter => {
                                    counterSelect.innerHTML += `<option value="${counter.id}">${counter.name}</option>`;
                                });
                                console.log('✅ Loaded counters from API:', endpoint);
                                break;
                            }
                        }
                    } catch (error) {
                        console.log(`Failed to load from ${endpoint}:`, error.message);
                    }
                }
            } catch (error) {
                console.error('Failed to load counters:', error);
                // Keep using default counters
            }
        }
        
        // Login handler
        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const counterId = document.getElementById('counter').value;
            
            if (!counterId) {
                showNotification('Please select a counter', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/terminal/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username,
                        password,
                        counterId: parseInt(counterId)
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    session = data;
                    localStorage.setItem('terminal-session', JSON.stringify(session));
                    startTerminal();
                } else {
                    showNotification('Invalid credentials', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Connection error. Starting demo mode...', 'warning');
                skipLogin();
            }
        }
        
        // Skip login (demo mode)
        function skipLogin() {
            isDemoMode = true;
            session = {
                id: 'demo-' + Date.now(),
                agent: { id: 0, name: 'Demo Agent' },
                counter: { id: 1, name: 'Counter 1', number: 1 },
                serviceId: 1,
                services: [
                    { id: 1, name: 'General Service', prefix: 'A' },
                    { id: 2, name: 'Account Services', prefix: 'B' },
                    { id: 3, name: 'VIP Services', prefix: 'V' },
                    { id: 4, name: 'Technical Support', prefix: 'T' }
                ]
            };
            
            // Create demo queue data
            queueData = [
                { id: 101, number: 'A045', state: 'waiting', priority: 0, waitTime: '15 min', serviceId: 1 },
                { id: 102, number: 'A046', state: 'waiting', priority: 1, waitTime: '18 min', serviceId: 1 },
                { id: 103, number: 'A047', state: 'waiting', priority: 0, waitTime: '22 min', serviceId: 1 }
            ];
            
            localStorage.setItem('terminal-session', JSON.stringify(session));
            startTerminal();
        }
        
        // Start terminal interface
        function startTerminal() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('terminalScreen').style.display = 'block';
            
            // Update UI with session info
            document.getElementById('agentName').textContent = session.agent.name;
            document.getElementById('sessionTime').textContent = 'agent • Level 5';
            document.getElementById('counterInfo').textContent = session.counter.name;
            
            if (isDemoMode) {
                document.getElementById('demoIndicator').style.display = 'block';
            }
            
            // Load services
            loadServices();
            
            // Check feature flags
            checkFeatureFlags();
            
            // Connect to Socket.IO
            connectSocket();
            
            // Start session timer
            startSessionTimer();
        }
        
        // Load services - fixed ID references
        async function loadServices() {
            const serviceSelect = document.getElementById('serviceSelect'); // Fixed ID
            
            // Default services
            const defaultServices = [
                { id: 1, name: 'General Service', prefix: 'A' },
                { id: 2, name: 'Account Services', prefix: 'B' },
                { id: 3, name: 'VIP Services', prefix: 'V' },
                { id: 4, name: 'Technical Support', prefix: 'T' }
            ];
            
            if (isDemoMode) {
                services = defaultServices;
                populateServiceSelect();
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/kiosk/services`);
                if (response.ok) {
                    const data = await response.json();
                    services = data.services || data || defaultServices;
                    console.log('✅ Loaded services from API');
                } else {
                    services = defaultServices;
                    console.log('⚠️ API failed, using default services');
                }
            } catch (error) {
                console.error('Error loading services:', error);
                services = defaultServices;
            }
            
            populateServiceSelect();
        }
        
        function populateServiceSelect() {
            const serviceSelect = document.getElementById('serviceSelect'); // Fixed ID
            if (!serviceSelect) {
                console.error('❌ Service select element not found');
                return;
            }
            
            serviceSelect.innerHTML = '<option value="">Select Service</option>';
            
            services.forEach((service, index) => {
                const option = document.createElement('option');
                option.value = service.id;
                option.textContent = service.name;
                if (index === 0) option.selected = true;
                serviceSelect.appendChild(option);
            });
            
            // Load queue for first service
            if (services.length > 0) {
                session.serviceId = services[0].id;
                loadQueue();
            }
        }
        
        // Check feature flags
        async function checkFeatureFlags() {
            if (isDemoMode) {
                // Show all features in demo mode
                document.querySelector('.btn-park').style.display = 'flex';
                document.querySelector('.btn-recycle').style.display = 'flex';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/settings`);
                if (response.ok) {
                    const settings = await response.json();
                    if (settings['feature.park_unpark'] === 'true') {
                        document.querySelector('.btn-park').style.display = 'flex';
                    }
                    if (settings['feature.recycle'] === 'true') {
                        document.querySelector('.btn-recycle').style.display = 'flex';
                    }
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }
        
        // Connect to Socket.IO
        function connectSocket() {
            if (typeof io === 'undefined' || isDemoMode) return;
            
            try {
                socket = io('/terminal', {
                    query: {
                        sessionId: session.id,
                        agentId: session.agent.id,
                        counterId: session.counter.id
                    }
                });
                
                socket.on('connect', () => {
                    updateConnectionStatus(true);
                    
                    // Join rooms
                    socket.emit('join-counter', session.counter.id);
                    if (session.serviceId) {
                        socket.emit('join-service', session.serviceId);
                    }
                    socket.emit('join-all');
                });
                
                socket.on('disconnect', () => {
                    updateConnectionStatus(false);
                });
                
                // Listen for events
                socket.on('ticket-created', (data) => {
                    if (data.ticket.serviceId === parseInt(session.serviceId)) {
                        loadQueue();
                        showNotification(`New ticket: ${data.ticket.number}`, 'info');
                    }
                });
                
                socket.on('ticket-called', (data) => {
                    loadQueue();
                });
                
                socket.on('ticket-completed', (data) => {
                    if (currentTicket && currentTicket.id === data.ticket.id) {
                        currentTicket = null;
                        updateCurrentTicketDisplay();
                    }
                });
                
                socket.on('ticket-parked', (data) => {
                    loadParkedTickets();
                });
                
                socket.on('queue-updated', (data) => {
                    if (data.serviceId === parseInt(session.serviceId)) {
                        loadQueue();
                    }
                });
                
                // Heartbeat
                setInterval(() => {
                    if (socket && socket.connected) {
                        socket.emit('heartbeat', { timestamp: Date.now() });
                    }
                }, 30000);
                
            } catch (error) {
                console.error('Socket connection error:', error);
            }
        }
        
        // Update connection status
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionStatus');
            const text = document.getElementById('connectionText');
            
            if (connected) {
                indicator.classList.remove('disconnected');
                text.textContent = 'Connected';
            } else {
                indicator.classList.add('disconnected');
                text.textContent = 'Disconnected';
            }
        }
        
        // Load queue - fixed ID reference
        async function loadQueue() {
            const serviceSelect = document.getElementById('serviceSelect'); // Fixed ID
            const serviceId = session?.serviceId || (serviceSelect ? serviceSelect.value : null);
            
            if (!serviceId) {
                console.log('⚠️ No service selected');
                return;
            }
            
            session.serviceId = serviceId;
            
            if (isDemoMode) {
                renderQueue();
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/terminal/queue/${serviceId}?sessionId=${session.id}`);
                if (response.ok) {
                    const data = await response.json();
                    queueData = data.tickets || [];
                    renderQueue();
                    console.log('✅ Loaded queue data');
                } else {
                    console.error('❌ Failed to load queue:', response.status);
                    // Use demo data as fallback
                    queueData = [
                        { id: 101, number: 'A045', state: 'waiting', priority: 0, waitTime: '15 min', serviceId: parseInt(serviceId) },
                        { id: 102, number: 'A046', state: 'waiting', priority: 1, waitTime: '18 min', serviceId: parseInt(serviceId) }
                    ];
                    renderQueue();
                }
            } catch (error) {
                console.error('Error loading queue:', error);
                // Use demo data as fallback
                queueData = [
                    { id: 101, number: 'A045', state: 'waiting', priority: 0, waitTime: '15 min', serviceId: parseInt(serviceId) },
                    { id: 102, number: 'A046', state: 'waiting', priority: 1, waitTime: '18 min', serviceId: parseInt(serviceId) }
                ];
                renderQueue();
            }
        }
        
        // Render queue
        function renderQueue() {
            const queueList = document.getElementById('queue-list');
            const waitingCount = queueData.filter(t => t.state === 'waiting').length;
            const servingCount = queueData.filter(t => t.state === 'serving' || t.state === 'called').length;
            
            document.getElementById('waiting-count').textContent = waitingCount;
            const servingElement = document.getElementById('serving-count');
            if (servingElement) {
                servingElement.textContent = servingCount;
            }
            
            let html = '';
            queueData.forEach(ticket => {
                const priorityClass = ticket.priority > 0 ? 'priority' : '';
                html += `
                    <div class="queue-item ${priorityClass}" onclick="cherryPick('${ticket.id}', '${ticket.number}')">
                        <div class="queue-ticket">
                            <div class="ticket-number">${ticket.number}</div>
                            <div class="ticket-time">Wait: ${ticket.waitTime || '15 min'}</div>
                        </div>
                        <div class="ticket-priority">
                            ${ticket.priority > 0 ? 'Priority' : 'Normal'}
                        </div>
                    </div>
                `;
            });
            
            queueList.innerHTML = html || '<div class="empty-state">No tickets in queue</div>';
        }
        
        // Cherry pick specific ticket
        async function cherryPick(ticketId, ticketNumber) {
            if (!confirm(`Call ticket ${ticketNumber}?`)) return;
            
            if (isDemoMode) {
                // Find and update ticket in demo mode
                const ticket = queueData.find(t => t.id == ticketId);
                if (ticket) {
                    ticket.state = 'called';
                    currentTicket = ticket;
                    updateCurrentTicketDisplay();
                    renderQueue();
                    addActivity(`Called ${ticketNumber} (cherry pick)`);
                    showNotification(`Now serving ${ticketNumber}`, 'success');
                }
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/terminal/call-ticket`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: session.id,
                        ticketId: ticketId
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentTicket = data.ticket;
                    updateCurrentTicketDisplay();
                    loadQueue();
                    addActivity(`Called ${ticketNumber} (cherry pick)`);
                    showNotification(`Now serving ${ticketNumber}`, 'success');
                } else {
                    showNotification('Failed to call ticket', 'error');
                }
            } catch (error) {
                console.error('Cherry pick error:', error);
                showNotification('Connection error', 'error');
            }
        }
        
        // Call next ticket in queue - fixed service selection
        async function handleCallNext() {
            const serviceSelect = document.getElementById('serviceSelect'); // Fixed ID
            const serviceId = session?.serviceId || (serviceSelect ? serviceSelect.value : null);
            
            if (!serviceId) {
                showNotification('Please select a service first', 'warning');
                return;
            }
            
            if (currentTicket) {
                showNotification('Please complete current ticket first', 'warning');
                return;
            }
            
            if (isDemoMode) {
                // Get next waiting ticket
                const nextTicket = queueData.find(t => t.state === 'waiting');
                if (nextTicket) {
                    nextTicket.state = 'called';
                    currentTicket = nextTicket;
                    updateCurrentTicketDisplay();
                    renderQueue();
                    addActivity(`Called ${nextTicket.number}`);
                    showNotification(`Now serving ${nextTicket.number}`, 'success');
                } else {
                    // Generate new demo ticket
                    const service = services.find(s => s.id == serviceId) || services[0];
                    const newTicket = {
                        id: Date.now(),
                        number: service.prefix + String(45 + Math.floor(Math.random() * 10)).padStart(3, '0'),
                        state: 'called',
                        priority: 0,
                        serviceId: parseInt(serviceId),
                        customer: { name: 'Demo Customer', phone: '+1234567890' }
                    };
                    currentTicket = newTicket;
                    updateCurrentTicketDisplay();
                    addActivity(`Called ${newTicket.number}`);
                    showNotification(`Now serving ${newTicket.number}`, 'success');
                }
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/terminal/call-next`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: session.id,
                        serviceId: parseInt(serviceId)
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentTicket = data.ticket;
                    updateCurrentTicketDisplay();
                    loadQueue();
                    addActivity(`Called ${data.ticket.number}`);
                    showNotification(`Now serving ${data.ticket.number}`, 'success');
                } else if (response.status === 404) {
                    showNotification('No tickets in queue', 'info');
                } else {
                    showNotification('Failed to call next ticket', 'error');
                }
            } catch (error) {
                console.error('Call next error:', error);
                showNotification('Connection error', 'error');
            }
        }
        
        // Recall current ticket
        async function handleRecall() {
            if (!currentTicket) {
                showNotification('No ticket to recall', 'warning');
                return;
            }
            
            if (isDemoMode) {
                addActivity(`Recalled ${currentTicket.number}`);
                showNotification(`Recalling ${currentTicket.number}`, 'info');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/terminal/recall`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: session.id
                    })
                });
                
                if (response.ok) {
                    addActivity(`Recalled ${currentTicket.number}`);
                    showNotification(`Recalling ${currentTicket.number}`, 'info');
                } else {
                    showNotification('Failed to recall ticket', 'error');
                }
            } catch (error) {
                console.error('Recall error:', error);
                showNotification('Connection error', 'error');
            }
        }
        
        // Complete current ticket
        async function handleComplete() {
            if (!currentTicket) {
                showNotification('No ticket to complete', 'warning');
                return;
            }
            
            if (isDemoMode) {
                const ticketNumber = currentTicket.number;
                currentTicket = null;
                updateCurrentTicketDisplay();
                document.getElementById('served-today').textContent = 
                    parseInt(document.getElementById('served-today').textContent) + 1;
                addActivity(`Completed ${ticketNumber}`);
                showNotification('Ticket completed', 'success');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/terminal/complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: session.id
                    })
                });
                
                if (response.ok) {
                    const ticketNumber = currentTicket.number;
                    currentTicket = null;
                    updateCurrentTicketDisplay();
                    document.getElementById('served-today').textContent = 
                        parseInt(document.getElementById('served-today').textContent) + 1;
                    addActivity(`Completed ${ticketNumber}`);
                    showNotification('Ticket completed', 'success');
                } else {
                    showNotification('Failed to complete ticket', 'error');
                }
            } catch (error) {
                console.error('Complete error:', error);
                showNotification('Connection error', 'error');
            }
        }
        
        // No show
        async function handleNoShow() {
            if (!currentTicket) {
                showNotification('No ticket to mark as no-show', 'warning');
                return;
            }
            
            if (isDemoMode) {
                const ticketNumber = currentTicket.number;
                currentTicket = null;
                updateCurrentTicketDisplay();
                addActivity(`No-show: ${ticketNumber}`);
                showNotification('Marked as no-show', 'info');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/terminal/no-show`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: session.id
                    })
                });
                
                if (response.ok) {
                    const ticketNumber = currentTicket.number;
                    currentTicket = null;
                    updateCurrentTicketDisplay();
                    addActivity(`No-show: ${ticketNumber}`);
                    showNotification('Marked as no-show', 'info');
                } else {
                    showNotification('Failed to mark as no-show', 'error');
                }
            } catch (error) {
                console.error('No-show error:', error);
                showNotification('Connection error', 'error');
            }
        }
        
        // Park current ticket
        async function handlePark() {
            if (!currentTicket) {
                showNotification('No ticket to park', 'warning');
                return;
            }
            
            if (isDemoMode) {
                currentTicket.state = 'parked';
                currentTicket.parkedAt = new Date();
                parkedTickets.push(currentTicket);
                currentTicket = null;
                updateCurrentTicketDisplay();
                renderParkedTickets();
                addActivity('Ticket parked');
                showNotification('Ticket parked', 'success');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/terminal/park`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: session.id
                    })
                });
                
                if (response.ok) {
                    currentTicket = null;
                    updateCurrentTicketDisplay();
                    loadParkedTickets();
                    addActivity('Ticket parked');
                    showNotification('Ticket parked', 'success');
                } else {
                    showNotification('Failed to park ticket', 'error');
                }
            } catch (error) {
                console.error('Park error:', error);
                showNotification('Connection error', 'error');
            }
        }
        
        // Recycle ticket
        async function handleRecycle() {
            if (!currentTicket) {
                showNotification('No ticket to recycle', 'warning');
                return;
            }
            
            if (isDemoMode) {
                const ticketNumber = currentTicket.number;
                // Add to queue at position 3
                queueData.splice(2, 0, {...currentTicket, state: 'waiting'});
                currentTicket = null;
                updateCurrentTicketDisplay();
                renderQueue();
                addActivity(`Recycled ${ticketNumber}`);
                showNotification('Ticket recycled to queue', 'success');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/terminal/recycle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: session.id
                    })
                });
                
                if (response.ok) {
                    const ticketNumber = currentTicket.number;
                    currentTicket = null;
                    updateCurrentTicketDisplay();
                    loadQueue();
                    addActivity(`Recycled ${ticketNumber}`);
                    showNotification('Ticket recycled to queue', 'success');
                } else {
                    showNotification('Failed to recycle ticket', 'error');
                }
            } catch (error) {
                console.error('Recycle error:', error);
                showNotification('Connection error', 'error');
            }
        }
        
        // Transfer ticket
        function handleTransfer() {
            if (!currentTicket) {
                showNotification('No ticket to transfer', 'warning');
                return;
            }
            
            // Show transfer modal
            const modal = document.getElementById('transferModal');
            const serviceGrid = document.getElementById('transferServices');
            
            // Populate services
            serviceGrid.innerHTML = '';
            services.forEach(service => {
                if (service.id != session.serviceId) {
                    serviceGrid.innerHTML += `
                        <div class="service-option" onclick="selectTransferService(${service.id}, '${service.name}')">
                            <div style="font-size: 24px">${service.prefix}</div>
                            <div>${service.name}</div>
                        </div>
                    `;
                }
            });
            
            modal.style.display = 'flex';
        }
        
        // Select transfer service
        function selectTransferService(serviceId, serviceName) {
            selectedTransferService = { id: serviceId, name: serviceName };
            
            // Update UI
            document.querySelectorAll('.service-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.target.closest('.service-option').classList.add('selected');
        }
        
        // Confirm transfer
        async function confirmTransfer() {
            if (!selectedTransferService) {
                showNotification('Please select a service', 'warning');
                return;
            }
            
            if (isDemoMode) {
                const ticketNumber = currentTicket.number;
                currentTicket = null;
                updateCurrentTicketDisplay();
                addActivity(`Transferred ${ticketNumber} to ${selectedTransferService.name}`);
                showNotification('Ticket transferred', 'success');
                closeTransferModal();
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/terminal/transfer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: session.id,
                        toServiceId: selectedTransferService.id
                    })
                });
                
                if (response.ok) {
                    const ticketNumber = currentTicket.number;
                    currentTicket = null;
                    updateCurrentTicketDisplay();
                    addActivity(`Transferred ${ticketNumber} to ${selectedTransferService.name}`);
                    showNotification('Ticket transferred', 'success');
                    closeTransferModal();
                } else {
                    showNotification('Failed to transfer ticket', 'error');
                }
            } catch (error) {
                console.error('Transfer error:', error);
                showNotification('Connection error', 'error');
            }
        }
        
        // Close transfer modal
        function closeTransferModal() {
            document.getElementById('transferModal').style.display = 'none';
            selectedTransferService = null;
        }
        
        // Transfer to counter (placeholder)
        function handleTransferCounter() {
            showNotification('Transfer to counter feature coming soon', 'info');
        }
        
        // Call supervisor
        function callSupervisor() {
            if (isDemoMode) {
                addActivity('Called supervisor');
                showNotification('Supervisor has been notified', 'info');
                return;
            }
            
            // In real implementation, this would send a notification
            addActivity('Called supervisor');
            showNotification('Supervisor has been notified', 'info');
        }
        
        // Update current ticket display
        function updateCurrentTicketDisplay() {
            const display = document.getElementById('current-ticket-display');
            
            if (!currentTicket) {
                display.innerHTML = '<div class="empty-state">No ticket being served</div>';
                return;
            }
            
            display.innerHTML = `
                <div class="ticket-service-info">
                    <div class="service-name">${getServiceName(currentTicket.serviceId || session.serviceId)}</div>
                    <div class="service-subtitle">Standard Processing</div>
                </div>
                <div class="serving-label">NOW SERVING</div>
                <div class="ticket-display">${currentTicket.number}</div>
                <div class="ticket-info">
                    <div class="info-item">
                        <div class="info-label">WAIT TIME</div>
                        <div class="info-value">${currentTicket.waitTime || '38:51'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">SERVICE TIME</div>
                        <div class="info-value">00:25</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">QUEUE POSITION</div>
                        <div class="info-value">#1</div>
                    </div>
                </div>
                <div class="customer-info">
                    <div class="customer-detail">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i>👤</i>
                            <div>
                                <div style="font-size: 11px; color: #999; text-transform: uppercase;">NAME</div>
                                <div style="font-size: 14px; font-weight: 500;">${currentTicket.customer?.name || 'Demo Customer'}</div>
                            </div>
                        </div>
                    </div>
                    <div class="customer-detail">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i>📱</i>
                            <div>
                                <div style="font-size: 11px; color: #999; text-transform: uppercase;">PHONE</div>
                                <div style="font-size: 14px; font-weight: 500;">${currentTicket.customer?.phone || '+1234567890'}</div>
                            </div>
                        </div>
                    </div>
                    <button style="margin-left: auto; padding: 8px 16px; background: white; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">View History</button>
                </div>
            `;
        }
        
        // Render parked tickets
        function renderParkedTickets() {
            const parkList = document.getElementById('park-list');
            
            let html = '';
            parkedTickets.forEach(ticket => {
                html += `
                    <div class="park-item" onclick="unparkTicket('${ticket.id}', '${ticket.number}')">
                        <div class="queue-ticket">
                            <div class="ticket-number">${ticket.number}</div>
                            <div class="ticket-time">Parked: ${new Date(ticket.parkedAt).toLocaleTimeString()}</div>
                        </div>
                        <div class="ticket-action">
                            <i>📤</i> Unpark
                        </div>
                    </div>
                `;
            });
            
            parkList.innerHTML = html || '<div class="empty-state">No parked tickets</div>';
        }
        
        // Unpark ticket
        async function unparkTicket(ticketId, ticketNumber) {
            if (!confirm(`Unpark and call ticket ${ticketNumber}?`)) return;
            
            if (isDemoMode) {
                // Find and unpark ticket in demo mode
                const index = parkedTickets.findIndex(t => t.id == ticketId);
                if (index !== -1) {
                    const ticket = parkedTickets.splice(index, 1)[0];
                    ticket.state = 'called';
                    currentTicket = ticket;
                    updateCurrentTicketDisplay();
                    renderParkedTickets();
                    addActivity(`Unparked and called ${ticketNumber}`);
                    showNotification(`Now serving ${ticketNumber}`, 'success');
                }
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/terminal/unpark`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: session.id,
                        ticketId: ticketId
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentTicket = data.ticket;
                    updateCurrentTicketDisplay();
                    loadParkedTickets();
                    addActivity(`Unparked and called ${ticketNumber}`);
                    showNotification(`Now serving ${ticketNumber}`, 'success');
                } else {
                    showNotification('Failed to unpark ticket', 'error');
                }
            } catch (error) {
                console.error('Unpark error:', error);
                showNotification('Connection error', 'error');
            }
        }
        
        // Load parked tickets
        async function loadParkedTickets() {
            if (isDemoMode) {
                renderParkedTickets();
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/terminal/parked?sessionId=${session.id}`);
                if (response.ok) {
                    const data = await response.json();
                    parkedTickets = data.tickets || [];
                    renderParkedTickets();
                }
            } catch (error) {
                console.error('Error loading parked tickets:', error);
            }
        }
        
        // Update activity feed
        function addActivity(text) {
            const feed = document.getElementById('activity-feed');
            const time = new Date().toLocaleTimeString();
            
            const item = document.createElement('div');
            item.className = 'activity-item';
            item.innerHTML = `
                <span class="activity-time">${time}</span>
                <span class="activity-text">${text}</span>
            `;
            
            feed.insertBefore(item, feed.firstChild);
            
            // Keep only last 10 items
            while (feed.children.length > 10) {
                feed.removeChild(feed.lastChild);
            }
        }
        
        // Switch tabs
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.tab-btn').classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(`${tab}-tab`).classList.add('active');
            
            // Load park tickets when switching to park tab
            if (tab === 'park') {
                loadParkedTickets();
            }
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Logout
        async function handleLogout() {
            if (isDemoMode) {
                localStorage.removeItem('terminal-session');
                location.reload();
                return;
            }
            
            try {
                await fetch(`${API_BASE}/api/terminal/logout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: session.id
                    })
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            localStorage.removeItem('terminal-session');
            location.reload();
        }
        
        // Check saved session
        function checkSavedSession() {
            const saved = localStorage.getItem('terminal-session');
            if (saved) {
                try {
                    session = JSON.parse(saved);
                    if (session.id.startsWith('demo-')) {
                        isDemoMode = true;
                    }
                    startTerminal();
                } catch (error) {
                    localStorage.removeItem('terminal-session');
                }
            }
        }
        
        // Session timer
        function startSessionTimer() {
            const startTime = Date.now();
            
            setInterval(() => {
                const elapsed = Date.now() - startTime;
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                document.getElementById('sessionTimer').textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }
        
        // Helper function to get service name
        function getServiceName(serviceId) {
            const service = services.find(s => s.id == serviceId);
            if (service) return service.name;
            
            // Default service names
            const defaultNames = {
                1: 'General Service',
                2: 'Account Services',
                3: 'VIP Services',
                4: 'Technical Support'
            };
            return defaultNames[serviceId] || 'Service';
        }
        
        // Toggle fullscreen
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        // Open help
        function openHelp() {
            showNotification('Help documentation coming soon', 'info');
        }
    </script>
</body>
</html>