<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowMatic Terminal - Advanced Professional</title>
    <script src="/socket.io/socket.io.js" onerror="console.warn('Socket.IO not available - running in offline mode')"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --cream: #faf9f6;
            --white: #ffffff;
            --light-gray: #f5f4f1;
            --gray: #e8e7e4;
            --medium-gray: #9b9b9b;
            --dark-gray: #6b6b6b;
            --black: #2c2c2c;
            --light-green: #86b97f;
            --light-orange: #ff9f54;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            --shadow-hover: 0 8px 24px rgba(0, 0, 0, 0.12);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--cream);
            color: var(--black);
            line-height: 1.6;
            overflow: hidden;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: var(--cream);
        }

        .login-box {
            background: var(--white);
            border-radius: 24px;
            padding: 3rem;
            box-shadow: var(--shadow-hover);
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--light-green), #7ab373);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: white;
            margin: 0 auto 1rem;
            box-shadow: 0 8px 24px rgba(134, 185, 127, 0.3);
        }

        .login-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 0.5rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--dark-gray);
        }

        .form-input, .form-select {
            padding: 0.75rem 1rem;
            background: var(--light-gray);
            border: 1px solid var(--gray);
            border-radius: 12px;
            font-size: 1rem;
            color: var(--black);
            transition: var(--transition);
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--light-green);
            box-shadow: 0 0 0 3px rgba(134, 185, 127, 0.1);
        }

        .login-btn {
            padding: 1rem;
            background: var(--light-green);
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 1rem;
        }

        .login-btn:hover {
            background: #7ab373;
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .skip-login-btn {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: 2px solid var(--gray);
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--dark-gray);
            cursor: pointer;
            transition: var(--transition);
        }

        .skip-login-btn:hover {
            border-color: var(--light-green);
            color: var(--light-green);
            transform: translateY(-1px);
        }

        .login-error {
            background: #fee;
            color: #c33;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            display: none;
        }

        /* Layout Grid */
        .terminal-container {
            display: none;
            grid-template-columns: 280px 1fr 320px;
            grid-template-rows: 70px 1fr 80px;
            height: 100vh;
            gap: 1px;
            background: var(--gray);
        }

        .terminal-container.active {
            display: grid;
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            box-shadow: var(--shadow);
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--light-green), #7ab373);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            color: white;
            box-shadow: 0 4px 12px rgba(134, 185, 127, 0.3);
        }

        .logo-text {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--black);
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--light-gray);
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--light-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.disconnected {
            background: #dc3545;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .agent-info {
            text-align: center;
        }

        .agent-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--black);
        }

        .agent-role {
            font-size: 0.8rem;
            color: var(--medium-gray);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-btn {
            padding: 0.5rem 1rem;
            background: var(--white);
            border: 1px solid var(--gray);
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--black);
            cursor: pointer;
            transition: var(--transition);
        }

        .header-btn:hover {
            background: var(--light-gray);
            transform: translateY(-1px);
        }

        .header-btn.danger {
            color: #dc3545;
            border-color: #dc3545;
        }

        /* Sidebar - Queue Selection */
        .sidebar {
            background: var(--white);
            padding: 1.5rem;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--medium-gray);
            margin-bottom: 1rem;
        }

        .queue-selector {
            background: var(--light-gray);
            border: 1px solid var(--gray);
            border-radius: 12px;
            padding: 0.75rem;
            width: 100%;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--black);
            cursor: pointer;
            transition: var(--transition);
        }

        .queue-selector:focus {
            outline: none;
            border-color: var(--light-green);
            box-shadow: 0 0 0 3px rgba(134, 185, 127, 0.1);
        }

        .priority-toggle {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .toggle-btn {
            flex: 1;
            padding: 0.6rem;
            background: var(--white);
            border: 1px solid var(--gray);
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--black);
            cursor: pointer;
            transition: var(--transition);
        }

        .toggle-btn.active {
            background: var(--light-green);
            color: white;
            border-color: var(--light-green);
        }

        /* Queue List */
        .queue-list {
            margin-top: 1.5rem;
        }

        .queue-empty {
            text-align: center;
            color: var(--medium-gray);
            padding: 2rem;
            font-size: 0.9rem;
        }

        .queue-item {
            background: var(--white);
            border: 1px solid var(--gray);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .queue-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow);
            border-color: var(--light-green);
        }

        .queue-item.priority {
            border-left: 4px solid var(--light-orange);
        }

        .queue-item .cherry-pick-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--light-green);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            opacity: 0;
            transition: var(--transition);
        }

        .queue-item:hover .cherry-pick-btn {
            opacity: 1;
        }

        .queue-item .cherry-pick-btn:hover {
            background: #7ab373;
        }

        .queue-number {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 0.25rem;
        }

        .queue-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--medium-gray);
        }

        /* Main Content Area */
        .main-content {
            background: var(--cream);
            display: flex;
            flex-direction: column;
            padding: 2rem;
            overflow: hidden;
        }

        .current-ticket {
            background: var(--white);
            border-radius: 24px;
            padding: 2.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            min-height: 380px;
        }

        .current-ticket::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--light-green), var(--light-orange));
        }

        .no-ticket {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 320px;
            color: var(--medium-gray);
        }

        .no-ticket-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .no-ticket-text {
            font-size: 1.2rem;
        }

        .ticket-content {
            display: none;
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
        }

        .ticket-number-large {
            font-size: 3.5rem;
            font-weight: 800;
            color: var(--black);
            line-height: 1;
            letter-spacing: -1px;
        }

        .ticket-service {
            text-align: right;
        }

        .service-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--black);
        }

        .service-type {
            font-size: 0.9rem;
            color: var(--medium-gray);
        }

        .ticket-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .detail-item {
            background: var(--light-gray);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
        }

        .detail-label {
            font-size: 0.8rem;
            color: var(--medium-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .detail-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--black);
        }

        .customer-info {
            background: var(--cream);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .customer-details {
            display: flex;
            gap: 3rem;
        }

        .customer-field {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .customer-icon {
            width: 36px;
            height: 36px;
            background: var(--white);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--medium-gray);
        }

        .customer-text {
            display: flex;
            flex-direction: column;
        }

        .customer-label {
            font-size: 0.75rem;
            color: var(--medium-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .customer-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--black);
        }

        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 1rem;
            margin-top: auto;
        }

        .action-btn {
            background: var(--white);
            border: 2px solid var(--gray);
            border-radius: 16px;
            padding: 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            color: var(--black);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .action-btn.large {
            grid-column: span 2;
            grid-row: span 2;
            font-size: 1.25rem;
        }

        .action-btn.large .action-btn-icon {
            font-size: 2.5rem;
        }

        .action-btn.large .action-btn-text {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .action-btn:hover:not(:disabled) {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-btn.primary {
            background: var(--light-green);
            border-color: var(--light-green);
            color: white;
        }

        .action-btn.primary:hover:not(:disabled) {
            background: #7ab373;
            border-color: #7ab373;
        }

        .action-btn.warning {
            border-color: var(--light-orange);
            color: var(--light-orange);
        }

        .action-btn.warning:hover:not(:disabled) {
            background: var(--light-orange);
            color: white;
        }

        .action-btn.danger {
            border-color: #dc3545;
            color: #dc3545;
        }

        .action-btn.danger:hover:not(:disabled) {
            background: #dc3545;
            color: white;
        }

        .action-btn-icon {
            font-size: 1.5rem;
        }

        .action-btn-text {
            font-size: 0.9rem;
        }

        /* Right Panel */
        .right-panel {
            background: var(--white);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-tabs {
            display: flex;
            border-bottom: 1px solid var(--gray);
        }

        .panel-tab {
            flex: 1;
            padding: 1rem;
            background: none;
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--medium-gray);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .panel-tab.active {
            color: var(--black);
        }

        .panel-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--light-green);
        }

        .panel-content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        /* Activity Feed */
        .activity-item {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--light-gray);
        }

        .activity-icon {
            width: 36px;
            height: 36px;
            background: var(--light-gray);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--black);
            margin-bottom: 0.25rem;
        }

        .activity-time {
            font-size: 0.8rem;
            color: var(--medium-gray);
        }

        /* Stats */
        .stat-card {
            background: var(--light-gray);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .stat-title {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--dark-gray);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--black);
        }

        .stat-change {
            font-size: 0.8rem;
            color: var(--light-green);
        }

        /* Messenger */
        .message-item {
            background: var(--light-gray);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .message-item:hover {
            background: var(--gray);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .message-from {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--black);
        }

        .message-time {
            font-size: 0.8rem;
            color: var(--medium-gray);
        }

        .message-preview {
            font-size: 0.85rem;
            color: var(--dark-gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-badge {
            display: inline-block;
            background: var(--light-orange);
            color: white;
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            margin-left: 0.5rem;
        }

        /* Footer */
        .footer {
            grid-column: 1 / -1;
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.06);
        }

        .footer-left {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--medium-gray);
        }

        .footer-center {
            display: flex;
            gap: 1rem;
        }

        .quick-action {
            padding: 0.5rem 1.25rem;
            background: var(--light-gray);
            border: 1px solid var(--gray);
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--black);
            cursor: pointer;
            transition: var(--transition);
        }

        .quick-action:hover {
            background: var(--gray);
        }

        .footer-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .timer {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--black);
            font-variant-numeric: tabular-nums;
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        // Toggle counter open/close
        function toggleCounter() {
            if (!session) return;
            
            const btn = document.getElementById('btnOpenClose');
            const currentText = btn.querySelector('.action-btn-text').textContent;
            const isOpen = currentText === 'CLOSE';
            
            // Demo mode
            if (session.id && session.id.startsWith('demo-')) {
                btn.querySelector('.action-btn-text').textContent = isOpen ? 'OPEN' : 'CLOSE';
                showNotification(`Counter ${isOpen ? 'closed' : 'opened'}`, 'success');
                return;
            }
            
            // Real API call would go here
            showNotification('Counter state updated', 'success');
        }

        .animate-in {
            animation: slideIn 0.3s ease-out;
        }

        /* Loading State */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 32px;
            height: 32px;
            border: 3px solid var(--gray);
            border-top-color: var(--light-green);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--white);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow-hover);
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification.success {
            border-left: 4px solid var(--light-green);
        }

        .notification.error {
            border-left: 4px solid #dc3545;
        }

        /* Transfer Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .transfer-modal {
            background: var(--white);
            border-radius: 20px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-hover);
            animation: slideIn 0.3s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--black);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--medium-gray);
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--black);
        }

        .service-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .service-option {
            background: var(--light-gray);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .service-option:hover {
            border-color: var(--light-green);
            transform: translateY(-2px);
        }

        .service-option.selected {
            background: var(--light-green);
            color: white;
            border-color: var(--light-green);
        }

        .service-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .service-name {
            font-size: 1rem;
            font-weight: 600;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-btn.cancel {
            background: var(--light-gray);
            color: var(--black);
        }

        .modal-btn.confirm {
            background: var(--light-green);
            color: white;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* Park Items */
        .park-item {
            background: var(--light-gray);
            border: 1px solid var(--gray);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .park-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow);
            border-color: var(--light-orange);
        }

        .park-item .unpark-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--light-orange);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            opacity: 0;
            transition: var(--transition);
        }

        .park-item:hover .unpark-btn {
            opacity: 1;
        }

        .park-time {
            font-size: 0.75rem;
            color: var(--medium-gray);
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <div class="login-header">
                <div class="login-logo">🎯</div>
                <h1 class="login-title">FlowMatic Terminal</h1>
                <p style="color: var(--medium-gray);">Sign in to continue</p>
            </div>
            
            <div class="login-error" id="loginError"></div>
            
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="username" placeholder="Enter your username" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="password" placeholder="Enter your password" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Select Counter</label>
                    <select class="form-select" id="counterId" required>
                        <option value="">Loading counters...</option>
                    </select>
                </div>
                
                <button type="submit" class="login-btn">Sign In</button>
            </form>
            
            <div style="text-align: center; margin-top: 1.5rem;">
                <button class="skip-login-btn" onclick="skipLogin()">
                    Skip Login (Demo Mode)
                </button>
                <p style="font-size: 0.8rem; color: var(--medium-gray); margin-top: 0.5rem;">
                    Use demo account for testing (or press Ctrl+D)
                </p>
            </div>
        </div>
    </div>

    <!-- Terminal Interface -->
    <div class="terminal-container" id="terminalScreen">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="logo">
                    <div class="logo-icon">🎯</div>
                    <div class="logo-text">FlowMatic Pro</div>
                </div>
                <div class="status-badge">
                    <div class="status-dot" id="connectionDot"></div>
                    <span id="counterStatus">Counter - Active</span>
                </div>
            </div>
            
            <div class="header-center">
                <div class="agent-info">
                    <div class="agent-name" id="agentName">-</div>
                    <div class="agent-role" id="agentRole">-</div>
                </div>
            </div>
            
            <div class="header-right">
                <button class="header-btn" id="alertsBtn">
                    <span>🔔</span>
                    <span>Alerts (<span id="alertCount">0</span>)</span>
                </button>
                <button class="header-btn">
                    <span>⚙️</span>
                    <span>Settings</span>
                </button>
                <button class="header-btn danger" id="logoutBtn">
                    <span>🚪</span>
                    <span>Logout</span>
                </button>
            </div>
        </header>

        <!-- Sidebar - Queue Management -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <h3 class="section-title">Queue Selection</h3>
                <select class="queue-selector" id="serviceSelector">
                    <option value="">Loading services...</option>
                </select>
                
                <div class="priority-toggle">
                    <button class="toggle-btn active" data-priority="0">Normal</button>
                    <button class="toggle-btn" data-priority="1">Priority</button>
                </div>
            </div>

            <div class="sidebar-section">
                <h3 class="section-title">Queue List (<span id="queueCount">0</span> Waiting)</h3>
                <div class="queue-list" id="queueList">
                    <div class="queue-empty">No tickets in queue</div>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Current Ticket Display -->
            <div class="current-ticket">
                <div class="no-ticket" id="noTicket">
                    <div class="no-ticket-icon">📋</div>
                    <div class="no-ticket-text">No ticket currently serving</div>
                    <p style="color: var(--medium-gray); margin-top: 1rem;">Click "NEXT" to call the next customer</p>
                </div>
                
                <div class="ticket-content" id="ticketContent">
                    <div class="ticket-header">
                        <div class="ticket-number-large" id="ticketNumber">-</div>
                        <div class="ticket-service">
                            <div class="service-name" id="serviceName">-</div>
                            <div class="service-type">Standard Processing</div>
                        </div>
                    </div>

                    <div class="ticket-details">
                        <div class="detail-item">
                            <div class="detail-label">Wait Time</div>
                            <div class="detail-value" id="waitTime">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Service Time</div>
                            <div class="detail-value" id="serviceTime">00:00</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Queue Position</div>
                            <div class="detail-value" id="queuePosition">-</div>
                        </div>
                    </div>

                    <div class="customer-info">
                        <div class="customer-details">
                            <div class="customer-field">
                                <div class="customer-icon">👤</div>
                                <div class="customer-text">
                                    <span class="customer-label">Name</span>
                                    <span class="customer-value" id="customerName">-</span>
                                </div>
                            </div>
                            <div class="customer-field">
                                <div class="customer-icon">📱</div>
                                <div class="customer-text">
                                    <span class="customer-label">Phone</span>
                                    <span class="customer-value" id="customerPhone">-</span>
                                </div>
                            </div>
                        </div>
                        <button class="header-btn">View History</button>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="action-btn primary large" id="btnNext">
                    <span class="action-btn-icon">▶️</span>
                    <span class="action-btn-text">NEXT</span>
                </button>
                <button class="action-btn warning" id="btnRecall" disabled>
                    <span class="action-btn-icon">🔄</span>
                    <span class="action-btn-text">RECALL</span>
                </button>
                <button class="action-btn" id="btnEnd" disabled>
                    <span class="action-btn-icon">✅</span>
                    <span class="action-btn-text">END</span>
                </button>
                <button class="action-btn danger" id="btnNoShow" disabled>
                    <span class="action-btn-icon">❌</span>
                    <span class="action-btn-text">NO SHOW</span>
                </button>
                <button class="action-btn" id="btnRecycle" disabled>
                    <span class="action-btn-icon">♻️</span>
                    <span class="action-btn-text">RECYCLE</span>
                </button>
                <button class="action-btn" id="btnPark" disabled>
                    <span class="action-btn-icon">🅿️</span>
                    <span class="action-btn-text">PARK</span>
                </button>
                <button class="action-btn" id="btnTransfer" disabled>
                    <span class="action-btn-icon">↔️</span>
                    <span class="action-btn-text">TRANSFER</span>
                </button>
                <button class="action-btn" id="btnTransferCounter" disabled>
                    <span class="action-btn-icon">🏪</span>
                    <span class="action-btn-text">TRANSFER CTR</span>
                </button>
                <button class="action-btn" id="btnOpenClose">
                    <span class="action-btn-icon">🔒</span>
                    <span class="action-btn-text">OPEN/CLOSE</span>
                </button>
            </div>
        </main>

        <!-- Right Panel - Activity/Stats/Messages -->
        <aside class="right-panel">
            <div class="panel-tabs">
                <button class="panel-tab active" data-panel="activity">Activity</button>
                <button class="panel-tab" data-panel="stats">Stats</button>
                <button class="panel-tab" data-panel="messages">Messages <span class="message-badge" id="messageBadge" style="display: none;">0</span></button>
            </div>

            <div class="panel-content">
                <!-- Activity Feed -->
                <div id="activityPanel">
                    <!-- Activities will be populated here -->
                </div>

                <!-- Stats Panel (Hidden by default) -->
                <div id="statsPanel" style="display: none;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Tickets Served Today</span>
                        </div>
                        <div class="stat-value" id="ticketsServed">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Avg Service Time</span>
                        </div>
                        <div class="stat-value" id="avgServiceTime">0:00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Current Queue Size</span>
                        </div>
                        <div class="stat-value" id="currentQueueSize">0</div>
                    </div>
                </div>

                <!-- Messages Panel (Hidden by default) -->
                <div id="messagesPanel" style="display: none;">
                    <div class="message-item">
                        <div class="message-header">
                            <span class="message-from">System</span>
                            <span class="message-time">Just now</span>
                        </div>
                        <div class="message-preview">Welcome to FlowMatic Terminal</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-left">
                <div class="connection-status">
                    <div class="status-dot" id="footerConnectionDot"></div>
                    <span id="connectionText">Connecting...</span>
                </div>
            </div>

            <div class="footer-center">
                <button class="quick-action">Break</button>
                <button class="quick-action">Help</button>
                <button class="quick-action">Supervisor</button>
            </div>

            <div class="footer-right">
                <span style="color: var(--medium-gray); font-size: 0.85rem;">Session Time:</span>
                <div class="timer" id="sessionTimer">00:00:00</div>
            </div>
        </footer>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.origin + '/api';  // Use current origin for API calls
        
        // State management
        let session = null;
        let socket = null;
        let currentTicket = null;
        let selectedService = null;
        let selectedPriority = 0;
        let serviceTimer = null;
        let sessionTimer = null;
        let ticketsServedCount = 0;
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkExistingSession();
            loadCounters();
            
            // Add keyboard shortcut for demo mode (Ctrl+D)
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'd' && document.getElementById('loginScreen').style.display !== 'none') {
                    e.preventDefault();
                    skipLogin();
                }
            });
        });
        
        // Skip login for demo mode
        function skipLogin() {
            // Create a demo session
            session = {
                id: 'demo-' + Math.random().toString(36).substr(2, 9),
                agent: {
                    id: 1,
                    name: 'Demo Agent',
                    username: 'demo',
                    role: 'agent'
                },
                counter: {
                    id: 1,
                    name: 'Counter 1',
                    number: 1,
                    location: 'Main Hall'
                }
            };
            
            // Store demo session
            localStorage.setItem('flowmatic_session', JSON.stringify(session));
            
            // Initialize terminal in demo mode
            initializeTerminal();
            
            // Show notification
            showNotification('Logged in as Demo Agent', 'success');
        }
        
        // Load available counters
        async function loadCounters() {
            try {
                // Try different possible endpoints
                let response = await fetch(`${API_BASE}/counters`);
                
                // If that fails, try admin endpoint
                if (!response.ok) {
                    response = await fetch(`${API_BASE}/admin/counters`);
                }
                
                // If still fails, try monitor endpoint
                if (!response.ok) {
                    response = await fetch(`${API_BASE}/monitor/counters`);
                }
                
                if (response.ok) {
                    const counters = await response.json();
                    const select = document.getElementById('counterId');
                    select.innerHTML = '<option value="">Choose a counter...</option>';
                    
                    // Handle different response formats
                    const counterList = Array.isArray(counters) ? counters : counters.counters || [];
                    
                    counterList.forEach(counter => {
                        const option = document.createElement('option');
                        option.value = counter.id;
                        option.textContent = `${counter.name} - ${counter.location || 'Main'}`;
                        select.appendChild(option);
                    });
                    
                    // If no counters from API, add default ones
                    if (counterList.length === 0) {
                        addDefaultCounters();
                    }
                } else {
                    // Add default counters if API fails
                    addDefaultCounters();
                }
            } catch (error) {
                console.error('Failed to load counters:', error);
                // Add default counters on error
                addDefaultCounters();
            }
        }
        
        // Add default counters for demo/testing
        function addDefaultCounters() {
            const select = document.getElementById('counterId');
            select.innerHTML = `
                <option value="">Choose a counter...</option>
                <option value="1">Counter 1 - Main Hall</option>
                <option value="2">Counter 2 - Main Hall</option>
                <option value="3">VIP Counter - VIP Area</option>
                <option value="4">Technical Counter - Technical Area</option>
            `;
        }
        
        // Load available services
        async function loadServices() {
            try {
                const response = await fetch(`${API_BASE}/services`);
                if (response.ok) {
                    const services = await response.json();
                    const select = document.getElementById('serviceSelector');
                    select.innerHTML = '';
                    
                    // Handle different response formats
                    const serviceList = Array.isArray(services) ? services : services.services || [];
                    
                    serviceList.forEach(service => {
                        if (service.is_active !== false) {
                            const option = document.createElement('option');
                            option.value = service.id;
                            option.textContent = service.name;
                            select.appendChild(option);
                        }
                    });
                    
                    // Select first service by default
                    if (serviceList.length > 0) {
                        selectedService = serviceList[0].id;
                        loadQueue();
                    } else {
                        // Add default services if none found
                        addDefaultServices();
                    }
                } else {
                    // Add default services if API fails
                    addDefaultServices();
                }
            } catch (error) {
                console.error('Failed to load services:', error);
                addDefaultServices();
            }
        }
        
        // Add default services for demo/testing
        function addDefaultServices() {
            const select = document.getElementById('serviceSelector');
            select.innerHTML = `
                <option value="1">General Service</option>
                <option value="2">Account Services</option>
                <option value="3">VIP Services</option>
                <option value="4">Technical Support</option>
            `;
            selectedService = 1;
            // Load empty queue for demo
            displayQueue([]);
        }
        
        // Login form submission
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const counterId = document.getElementById('counterId').value;
            
            if (!counterId) {
                showLoginError('Please select a counter');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/terminal/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, counterId })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    session = data.session;
                    localStorage.setItem('flowmatic_session', JSON.stringify(session));
                    initializeTerminal();
                } else {
                    showLoginError('Invalid username or password');
                }
            } catch (error) {
                console.error('Login error:', error);
                showLoginError('Unable to connect to server. Try demo mode or check your connection.');
            }
        });
        
        // Show login error
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        // Check for existing session
        async function checkExistingSession() {
            const savedSession = localStorage.getItem('flowmatic_session');
            if (savedSession) {
                session = JSON.parse(savedSession);
                
                try {
                    const response = await fetch(`${API_BASE}/terminal/session/${session.id}`);
                    if (response.ok) {
                        initializeTerminal();
                    } else {
                        localStorage.removeItem('flowmatic_session');
                    }
                } catch (error) {
                    localStorage.removeItem('flowmatic_session');
                }
            }
        }
        
        // Initialize terminal
        function initializeTerminal() {
            // Show terminal screen
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('terminalScreen').classList.add('active');
            
            // Update UI with session info
            document.getElementById('agentName').textContent = session.agent.name;
            document.getElementById('agentRole').textContent = `${session.agent.role} • Level 5`;
            
            // Add demo mode indicator
            if (session.id && session.id.startsWith('demo-')) {
                document.getElementById('counterStatus').textContent = `Demo Mode - Counter ${session.counter.number || session.counter.id}`;
                document.getElementById('counterStatus').style.color = 'var(--light-orange)';
            } else {
                document.getElementById('counterStatus').textContent = `Counter ${session.counter.number || session.counter.id} Active`;
            }
            
            // Start session timer
            startSessionTimer();
            
            // Connect to Socket.IO
            connectSocket();
            
            // Load initial data
            loadServices();
            
            // Setup event listeners
            setupEventListeners();
        }
        
        // Connect to Socket.IO
        function connectSocket() {
            try {
                // Check if io is defined (Socket.IO loaded)
                if (typeof io === 'undefined') {
                    console.warn('Socket.IO not loaded, running in offline mode');
                    updateConnectionStatus(false);
                    return;
                }
                
                socket = io('/terminal', {
                    reconnection: true,
                    reconnectionDelay: 1000,
                    reconnectionAttempts: 5
                });
                
                socket.on('connect', () => {
                    console.log('Connected to server');
                    updateConnectionStatus(true);
                    
                    // Join service room
                    if (selectedService) {
                        socket.emit('join-service', { serviceId: selectedService });
                    }
                    
                    // Join counter room
                    if (session && session.counter) {
                        socket.emit('join-counter', { counterId: session.counter.id });
                    }
                });
                
                socket.on('disconnect', () => {
                    console.log('Disconnected from server');
                    updateConnectionStatus(false);
                });
                
                socket.on('connect_error', (error) => {
                    console.warn('Socket connection error:', error.message);
                    updateConnectionStatus(false);
                });
                
                // Handle real-time events
                socket.on('ticket-created', handleTicketCreated);
                socket.on('ticket-called', handleTicketCalled);
                socket.on('ticket-completed', handleTicketCompleted);
                socket.on('queue-updated', handleQueueUpdated);
                socket.on('system-alert', handleSystemAlert);
                
                // Handle welcome message
                socket.on('welcome', (data) => {
                    console.log('Welcome message:', data);
                });
                
                // Handle heartbeat
                socket.on('heartbeat-ping', (data) => {
                    socket.emit('heartbeat-pong', { timestamp: Date.now() });
                });
            } catch (error) {
                console.error('Failed to connect Socket.IO:', error);
                updateConnectionStatus(false);
            }
        }
        
        // Update connection status
        function updateConnectionStatus(connected) {
            const dots = document.querySelectorAll('.status-dot');
            const connectionText = document.getElementById('connectionText');
            
            dots.forEach(dot => {
                if (connected) {
                    dot.classList.remove('disconnected');
                } else {
                    dot.classList.add('disconnected');
                }
            });
            
            connectionText.textContent = connected 
                ? 'Connected • Real-time sync active' 
                : 'Disconnected • Attempting to reconnect...';
        }
        
        // Load queue
        async function loadQueue() {
            if (!selectedService) return;
            
            // Demo mode - show some sample tickets
            if (session && session.id && session.id.startsWith('demo-')) {
                const demoTickets = [
                    {
                        id: 1,
                        ticket_number: 'A045',
                        service_id: selectedService,
                        priority: 0,
                        created_at: new Date(Date.now() - 900000).toISOString() // 15 min ago
                    },
                    {
                        id: 2,
                        ticket_number: 'A046',
                        service_id: selectedService,
                        priority: 1,
                        created_at: new Date(Date.now() - 1080000).toISOString() // 18 min ago
                    },
                    {
                        id: 3,
                        ticket_number: 'A047',
                        service_id: selectedService,
                        priority: 0,
                        created_at: new Date(Date.now() - 1320000).toISOString() // 22 min ago
                    }
                ];
                displayQueue(demoTickets);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/terminal/queue/${selectedService}?priority=${selectedPriority}`);
                if (response.ok) {
                    const data = await response.json();
                    displayQueue(data.tickets || []);
                } else {
                    displayQueue([]);
                }
            } catch (error) {
                console.error('Failed to load queue:', error);
                displayQueue([]);
            }
        }
        
        // Display queue
        function displayQueue(tickets) {
            const queueList = document.getElementById('queueList');
            const queueCount = document.getElementById('queueCount');
            
            queueCount.textContent = tickets.length;
            document.getElementById('currentQueueSize').textContent = tickets.length;
            
            if (tickets.length === 0) {
                queueList.innerHTML = '<div class="queue-empty">No tickets in queue</div>';
                return;
            }
            
            queueList.innerHTML = '';
            tickets.forEach(ticket => {
                const waitMinutes = Math.floor((Date.now() - new Date(ticket.created_at).getTime()) / 60000);
                
                const item = document.createElement('div');
                item.className = `queue-item animate-in ${ticket.priority > 0 ? 'priority' : ''}`;
                item.innerHTML = `
                    <div class="queue-number">${ticket.ticket_number}</div>
                    <div class="queue-meta">
                        <span>Wait: ${waitMinutes} min</span>
                        <span>${ticket.priority > 0 ? 'Priority' : 'Normal'}</span>
                    </div>
                `;
                queueList.appendChild(item);
            });
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Service selector
            document.getElementById('serviceSelector').addEventListener('change', (e) => {
                selectedService = parseInt(e.target.value);
                if (socket && selectedService) {
                    socket.emit('join-service', { serviceId: selectedService });
                }
                loadQueue();
            });
            
            // Priority toggle
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedPriority = parseInt(this.dataset.priority);
                    loadQueue();
                });
            });
            
            // Action buttons
            document.getElementById('btnNext').addEventListener('click', callNext);
            document.getElementById('btnRecall').addEventListener('click', recall);
            document.getElementById('btnEnd').addEventListener('click', complete);
            document.getElementById('btnNoShow').addEventListener('click', noShow);
            document.getElementById('btnRecycle').addEventListener('click', recycle);
            document.getElementById('btnPark').addEventListener('click', park);
            document.getElementById('btnTransfer').addEventListener('click', transfer);
            document.getElementById('btnOpenClose').addEventListener('click', toggleCounter);
            
            // Panel tabs
            document.querySelectorAll('.panel-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Hide all panels
                    document.getElementById('activityPanel').style.display = 'none';
                    document.getElementById('statsPanel').style.display = 'none';
                    document.getElementById('messagesPanel').style.display = 'none';
                    
                    // Show selected panel
                    const panelId = this.dataset.panel + 'Panel';
                    document.getElementById(panelId).style.display = 'block';
                });
            });
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', logout);
        }
        
        // Call next ticket
        async function callNext() {
            if (!session || !selectedService) return;
            
            // Demo mode handling
            if (session.id && session.id.startsWith('demo-')) {
                // Create a demo ticket
                currentTicket = {
                    id: Math.floor(Math.random() * 1000),
                    ticket_number: 'A' + String(Math.floor(Math.random() * 100) + 1).padStart(3, '0'),
                    service_id: selectedService,
                    customer_name: 'Demo Customer',
                    customer_phone: '+1234567890',
                    created_at: new Date(Date.now() - Math.random() * 3600000).toISOString(),
                    called_at: new Date().toISOString()
                };
                updateTicketDisplay();
                startServiceTimer();
                addActivity('Called', currentTicket.ticket_number);
                showNotification(`Called ticket ${currentTicket.ticket_number}`, 'success');
                return;
            }
            
            try {
                const btn = document.getElementById('btnNext');
                btn.classList.add('loading');
                
                const response = await fetch(`${API_BASE}/terminal/call-next`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: session.id,
                        serviceId: selectedService
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentTicket = data.ticket;
                    updateTicketDisplay();
                    startServiceTimer();
                    addActivity('Called', currentTicket.ticket_number);
                    showNotification(`Called ticket ${currentTicket.ticket_number}`, 'success');
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'No tickets available', 'error');
                }
            } catch (error) {
                showNotification('Failed to call next ticket', 'error');
            } finally {
                document.getElementById('btnNext').classList.remove('loading');
            }
        }
        
        // Complete ticket
        async function complete() {
            if (!session || !currentTicket) return;
            
            // Demo mode handling
            if (session.id && session.id.startsWith('demo-')) {
                addActivity('Completed', currentTicket.ticket_number);
                showNotification(`Completed ticket ${currentTicket.ticket_number}`, 'success');
                currentTicket = null;
                updateTicketDisplay();
                
                // Update demo stats
                ticketsServedCount++;
                document.getElementById('ticketsServed').textContent = ticketsServedCount;
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/terminal/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: session.id,
                        ticketId: currentTicket.id
                    })
                });
                
                if (response.ok) {
                    addActivity('Completed', currentTicket.ticket_number);
                    showNotification(`Completed ticket ${currentTicket.ticket_number}`, 'success');
                    currentTicket = null;
                    updateTicketDisplay();
                    loadQueue();
                    
                    // Update stats
                    ticketsServedCount++;
                    document.getElementById('ticketsServed').textContent = ticketsServedCount;
                }
            } catch (error) {
                showNotification('Failed to complete ticket', 'error');
            }
        }
        
        // Recall ticket
        async function recall() {
            if (!session || !currentTicket) return;
            
            // Demo mode handling
            if (session.id && session.id.startsWith('demo-')) {
                addActivity('Recalled', currentTicket.ticket_number);
                showNotification(`Recalled ticket ${currentTicket.ticket_number}`, 'success');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/terminal/recall`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: session.id,
                        ticketId: currentTicket.id
                    })
                });
                
                if (response.ok) {
                    addActivity('Recalled', currentTicket.ticket_number);
                    showNotification(`Recalled ticket ${currentTicket.ticket_number}`, 'success');
                }
            } catch (error) {
                showNotification('Failed to recall ticket', 'error');
            }
        }
        
        // No show
        async function noShow() {
            if (!session || !currentTicket) return;
            
            // Demo mode handling
            if (session.id && session.id.startsWith('demo-')) {
                addActivity('No show', currentTicket.ticket_number);
                showNotification(`Marked ${currentTicket.ticket_number} as no-show`, 'success');
                currentTicket = null;
                updateTicketDisplay();
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/terminal/no-show`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: session.id,
                        ticketId: currentTicket.id
                    })
                });
                
                if (response.ok) {
                    addActivity('No show', currentTicket.ticket_number);
                    showNotification(`Marked ${currentTicket.ticket_number} as no-show`, 'success');
                    currentTicket = null;
                    updateTicketDisplay();
                    loadQueue();
                }
            } catch (error) {
                showNotification('Failed to mark no-show', 'error');
            }
        }
        
        // Park ticket
        async function park() {
            if (!session || !currentTicket) return;
            
            // Demo mode handling
            if (session.id && session.id.startsWith('demo-')) {
                addActivity('Parked', currentTicket.ticket_number);
                showNotification(`Parked ticket ${currentTicket.ticket_number}`, 'success');
                currentTicket = null;
                updateTicketDisplay();
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/terminal/park`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: session.id,
                        ticketId: currentTicket.id
                    })
                });
                
                if (response.ok) {
                    addActivity('Parked', currentTicket.ticket_number);
                    showNotification(`Parked ticket ${currentTicket.ticket_number}`, 'success');
                    currentTicket = null;
                    updateTicketDisplay();
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to park ticket', 'error');
                }
            } catch (error) {
                showNotification('Failed to park ticket', 'error');
            }
        }
        
        // Recycle ticket
        async function recycle() {
            if (!session || !currentTicket) return;
            
            // Demo mode handling
            if (session.id && session.id.startsWith('demo-')) {
                addActivity('Recycled', currentTicket.ticket_number);
                showNotification(`Recycled ticket ${currentTicket.ticket_number}`, 'success');
                currentTicket = null;
                updateTicketDisplay();
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/terminal/recycle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: session.id,
                        ticketId: currentTicket.id
                    })
                });
                
                if (response.ok) {
                    addActivity('Recycled', currentTicket.ticket_number);
                    showNotification(`Recycled ticket ${currentTicket.ticket_number}`, 'success');
                    currentTicket = null;
                    updateTicketDisplay();
                    loadQueue();
                }
            } catch (error) {
                showNotification('Failed to recycle ticket', 'error');
            }
        }
        
        // Transfer ticket
        async function transfer() {
            if (!session || !currentTicket) return;
            
            // Demo mode handling
            if (session.id && session.id.startsWith('demo-')) {
                const services = ['General Service', 'Account Services', 'VIP Services', 'Technical Support'];
                const currentServiceName = getServiceName(currentTicket.service_id);
                const otherServices = services.filter(s => s !== currentServiceName);
                
                const selection = prompt(`Transfer to which service?\n\n${otherServices.map((s, i) => `${i+1}: ${s}`).join('\n')}\n\nEnter number (1-${otherServices.length}):`);
                
                if (selection) {
                    const index = parseInt(selection) - 1;
                    if (index >= 0 && index < otherServices.length) {
                        addActivity('Transferred', `${currentTicket.ticket_number} to ${otherServices[index]}`);
                        showNotification(`Transferred to ${otherServices[index]}`, 'success');
                        currentTicket = null;
                        updateTicketDisplay();
                    } else {
                        showNotification('Invalid selection', 'error');
                    }
                }
                return;
            }
            
            // Real mode - API call
            try {
                const response = await fetch(`${API_BASE}/services`);
                if (!response.ok) {
                    showNotification('Failed to load services', 'error');
                    return;
                }
                
                const services = await response.json();
                const serviceList = Array.isArray(services) ? services : services.services || [];
                const otherServices = serviceList.filter(s => s.id !== currentTicket.service_id && s.is_active !== false);
                
                if (otherServices.length === 0) {
                    showNotification('No other services available', 'error');
                    return;
                }
                
                const serviceOptions = otherServices.map(s => `${s.id}: ${s.name}`).join('\n');
                const selection = prompt(`Transfer to which service?\n\n${serviceOptions}\n\nEnter service number:`);
                
                if (!selection) return;
                
                const targetServiceId = parseInt(selection);
                if (!otherServices.find(s => s.id === targetServiceId)) {
                    showNotification('Invalid service selection', 'error');
                    return;
                }
                
                const transferResponse = await fetch(`${API_BASE}/terminal/transfer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: session.id,
                        ticketId: currentTicket.id,
                        toServiceId: targetServiceId
                    })
                });
                
                if (transferResponse.ok) {
                    const targetService = otherServices.find(s => s.id === targetServiceId);
                    addActivity('Transferred', `${currentTicket.ticket_number} to ${targetService.name}`);
                    showNotification(`Transferred to ${targetService.name}`, 'success');
                    currentTicket = null;
                    updateTicketDisplay();
                    loadQueue();
                }
            } catch (error) {
                showNotification('Failed to transfer ticket', 'error');
            }
        }
        
        // Update ticket display
        function updateTicketDisplay() {
            const noTicket = document.getElementById('noTicket');
            const ticketContent = document.getElementById('ticketContent');
            
            if (!currentTicket) {
                noTicket.style.display = 'flex';
                ticketContent.style.display = 'none';
                
                // Disable action buttons
                ['btnRecall', 'btnEnd', 'btnNoShow', 'btnRecycle', 'btnPark', 'btnTransfer'].forEach(id => {
                    document.getElementById(id).disabled = true;
                });
                
                // Clear service timer
                if (serviceTimer) {
                    clearInterval(serviceTimer);
                    serviceTimer = null;
                }
            } else {
                noTicket.style.display = 'none';
                ticketContent.style.display = 'block';
                
                // Update ticket info
                document.getElementById('ticketNumber').textContent = currentTicket.ticket_number;
                document.getElementById('serviceName').textContent = getServiceName(currentTicket.service_id);
                
                const waitTime = Math.floor((new Date(currentTicket.called_at || Date.now()).getTime() - new Date(currentTicket.created_at).getTime()) / 1000);
                document.getElementById('waitTime').textContent = formatTime(waitTime);
                document.getElementById('queuePosition').textContent = '#1';
                document.getElementById('customerName').textContent = currentTicket.customer_name || 'Walk-in Customer';
                document.getElementById('customerPhone').textContent = currentTicket.customer_phone || 'No phone';
                
                // Enable action buttons
                ['btnRecall', 'btnEnd', 'btnNoShow', 'btnPark', 'btnTransfer'].forEach(id => {
                    document.getElementById(id).disabled = false;
                });
                
                // Check feature flags for advanced buttons
                checkFeatureFlags();
            }
        }
        
        // Check feature flags
        async function checkFeatureFlags() {
            // In demo mode, show all features
            if (session && session.id && session.id.startsWith('demo-')) {
                document.getElementById('btnPark').style.display = 'flex';
                document.getElementById('btnRecycle').style.display = 'flex';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/settings`);
                if (response.ok) {
                    const settings = await response.json();
                    
                    // Show/hide buttons based on features
                    document.getElementById('btnPark').style.display = 
                        settings['feature.park_unpark'] === 'true' ? 'flex' : 'none';
                    document.getElementById('btnRecycle').style.display = 
                        settings['feature.recycle'] === 'true' ? 'flex' : 'none';
                } else {
                    // Default to hiding advanced features if API fails
                    document.getElementById('btnPark').style.display = 'none';
                    document.getElementById('btnRecycle').style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to load feature flags:', error);
                // Default to hiding advanced features on error
                document.getElementById('btnPark').style.display = 'none';
                document.getElementById('btnRecycle').style.display = 'none';
            }
        }
        
        // Socket event handlers
        function handleTicketCreated(data) {
            if (data.ticket.serviceId === selectedService) {
                loadQueue();
                addActivity('New ticket', data.ticket.number);
            }
        }
        
        function handleTicketCalled(data) {
            if (data.ticket.serviceId === selectedService) {
                loadQueue();
            }
        }
        
        function handleTicketCompleted(data) {
            if (data.ticketId === currentTicket?.id) {
                currentTicket = null;
                updateTicketDisplay();
            }
            loadQueue();
        }
        
        function handleQueueUpdated(data) {
            if (data.serviceId === selectedService) {
                loadQueue();
            }
        }
        
        function handleSystemAlert(data) {
            showNotification(data.message, data.type || 'info');
        }
        
        // Helper functions
        function getServiceName(serviceId) {
            const services = {
                1: 'General Service',
                2: 'Account Services', 
                3: 'VIP Services',
                4: 'Technical Support'
            };
            return services[serviceId] || 'Unknown Service';
        }
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        
        function startServiceTimer() {
            let seconds = 0;
            if (serviceTimer) clearInterval(serviceTimer);
            
            serviceTimer = setInterval(() => {
                seconds++;
                document.getElementById('serviceTime').textContent = formatTime(seconds);
            }, 1000);
        }
        
        function startSessionTimer() {
            let seconds = 0;
            sessionTimer = setInterval(() => {
                seconds++;
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                
                document.getElementById('sessionTimer').textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }, 1000);
        }
        
        function addActivity(action, detail) {
            const activityPanel = document.getElementById('activityPanel');
            const activity = document.createElement('div');
            activity.className = 'activity-item animate-in';
            activity.innerHTML = `
                <div class="activity-icon">🎯</div>
                <div class="activity-content">
                    <div class="activity-title">${action} - ${detail}</div>
                    <div class="activity-time">Just now</div>
                </div>
            `;
            activityPanel.insertBefore(activity, activityPanel.firstChild);
            
            // Keep only last 10 activities
            while (activityPanel.children.length > 10) {
                activityPanel.removeChild(activityPanel.lastChild);
            }
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${type === 'success' ? '✅' : '❌'}</span>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Call logout endpoint (skip for demo mode)
                if (session && !session.id.startsWith('demo-')) {
                    fetch(`${API_BASE}/terminal/logout`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sessionId: session.id })
                    }).catch(error => console.error('Logout error:', error));
                }
                
                localStorage.removeItem('flowmatic_session');
                if (socket) socket.disconnect();
                location.reload();
            }
        }
    </script>
</body>
</html>